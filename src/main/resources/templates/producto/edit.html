<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Editar Producto</title>
</head>
<body>
<div layout:fragment="content" class="container mt-4">

    <h2 class="mb-4">Editar Producto</h2>

    <!-- Mensajes de confirmación / error -->
    <div th:if="${msg != null}" th:text="${msg}" class="alert alert-success"></div>
    <div th:if="${error != null}" th:text="${error}" class="alert alert-danger"></div>

    <form th:action="@{/productos/update}" th:object="${producto}" method="post" enctype="multipart/form-data">
        <input type="hidden" th:field="*{id}"/>

        <div class="mb-3">
            <label class="form-label">Nombre *</label>
            <input type="text" th:field="*{nombre}" class="form-control" required>
            <div class="text-danger" th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}"></div>
        </div>

        <div class="mb-3">
            <label class="form-label">Descripción</label>
            <textarea th:field="*{descripcion}" class="form-control"></textarea>
            <div class="text-danger" th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}"></div>
        </div>

        <!-- Precio de compra -->
        <div class="mb-3">
            <label for="precio_compra" class="form-label">Precio Compra <span class="text-danger">*</span></label>
        <input type="number" th:field="*{precio_compra}" step="0.01" class="form-control" id="precio_compra" placeholder="0.00" required>
        </div>

        <!-- Precio de venta -->
            <div class="mb-3">
                <label for="precio_venta" class="form-label">Precio Venta <span class="text-danger">*</span></label>
        <input type="number" th:field="*{precio_venta}" step="0.01" class="form-control" id="precio_venta" placeholder="0.00" required>
            </div>

        <!-- Costo promedio -->
                <div class="mb-3">
                    <label for="costo_promedio" class="form-label">Costo Promedio <span class="text-danger">*</span></label>
        <input type="number" th:field="*{costo_promedio}" step="0.01" class="form-control" id="costo_promedio" placeholder="0.00" required>
                </div>


        <!-- Stock actual -->
        <div class="mb-3">
            <label for="stock_actual" class="form-label">Stock Actual <span class="text-danger">*</span></label>
            <input type="number" th:field="*{stock_actual}" class="form-control" id="stock_actual" min="0" required>
            <div class="text-danger" th:if="${#fields.hasErrors('stock_actual')}" th:errors="*{stock_actual}"></div>
        </div>

        <!-- Stock mínimo -->
        <div class="mb-3">
            <label for="stock_minimo" class="form-label">Stock Mínimo <span class="text-danger">*</span></label>
            <input type="number" th:field="*{stock_minimo}" class="form-control" id="stock_minimo" min="0" required>
            <div class="text-danger" th:if="${#fields.hasErrors('stock_minimo')}" th:errors="*{stock_minimo}"></div>
        </div>

        <!-- Mostrar estado dinámicamente -->
        <div class="mb-3">
            <label class="form-label">Estado:</label>
            <span th:switch="${producto.estadoStock}">
                <span th:case="T(org.esfe.AppRyDBodega_Pro.modelos.Producto.EstadoStock).AGOTADO"
                      class="badge bg-danger">Agotado</span>
                <span th:case="T(org.esfe.AppRyDBodega_Pro.modelos.Producto.EstadoStock).TERMINANDO"
                      class="badge bg-warning text-dark">Terminando</span>
                <span th:case="T(org.esfe.AppRyDBodega_Pro.modelos.Producto.EstadoStock).BUENO"
                      class="badge bg-success">Disponible</span>
            </span>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Categoría *</label>
                <select th:field="*{categoria}" class="form-select" required>
                    <option value="">Seleccione una categoría</option>
                    <option th:each="categoria : ${categorias}"
                            th:value="${categoria}"
                            th:text="${categoria.nombre}"
                            th:selected="${categoria.id == producto.categoria.id}"></option>
                </select>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Proveedor</label>
                <select th:field="*{proveedor}" class="form-select">
                    <option value="">Seleccione un proveedor</option>
                    <option th:each="proveedor : ${proveedores}"
                            th:value="${proveedor}"
                            th:text="${proveedor.nombre}"
                            th:selected="${proveedor.id == producto.proveedor.id}"></option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="fileImagen">Imagen actual:</label>
            <img th:if="${producto.imagen_url != null}"
                 th:src="@{'/producto/imagen_url/' + ${producto.id}}"
                 style="max-width: 200px; max-height: 200px;" id="vista-previa"/>
            <input type="file" class="form-control mt-2" id="fileImagen" name="fileImagen" accept="image/*"/>
            <input type="hidden" th:field="*{imagen_url}" />
            <small class="form-text text-muted">Deja en blanco para mantener la imagen actual</small>
        </div>

        <div class="d-flex justify-content-between">
            <a th:href="@{/productos}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-success">Actualizar</button>
        </div>
    </form>

    <script>
        const imagenInput = document.getElementById('fileImagen');
        const vistaPrevia = document.getElementById('vista-previa');

        imagenInput.addEventListener('change', function (event) {
            const archivo = event.target.files[0];
            if (archivo) {
                const lector = new FileReader();

                lector.onload = function (e) {
                    vistaPrevia.src = e.target.result;
                    vistaPrevia.style.display = 'block';
                };

                lector.readAsDataURL(archivo);
            } else {
                vistaPrevia.src = '#';
                vistaPrevia.style.display = 'none';
            }
        });
    </script>

</div>
</body>
</html>